<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Ø¢Ù„Ø© Ø­Ø§Ø³Ø¨Ø©</title>
  <link rel="stylesheet" href="./shared.css" />
  <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
  <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  <script defer src="./shared.js"></script>
</head>
<body>
<header class="app-header">
  <div class="brand"><span class="logo">ğŸ§®</span><h1>Ø¢Ù„Ø© Ø­Ø§Ø³Ø¨Ø©</h1></div>
  <nav class="nav">
    <a href="./index.html">Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©</a>
    <a href="./snake.html">Ø§Ù„Ø«Ø¹Ø¨Ø§Ù†</a>
    <a href="./tetris.html">ØªØªØ±ÙŠØ³</a>
    <a href="./pacman.html">Ø¨Ø§ÙƒÙ…Ø§Ù†</a>
    <a href="./mario.html">Ø³ÙˆØ¨Ø± Ù…Ø§Ø±ÙŠÙˆ</a>
  </nav>
  <button id="theme-toggle" class="btn">ğŸŒ“</button>
</header>

<main class="container">
  <div id="root"></div>
</main>

<footer class="app-footer">
  <small>Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø­Ù‚ÙˆÙ‚ Ù…Ø­ÙÙˆØ¸Ø© 2025 â€” Ø§Ù„Ù…Ø·ÙˆØ± Ù„ÙŠØ« - Ù…Ø·ÙˆØ± ØªØ·Ø¨ÙŠÙ‚ Ø±ÙÙŠÙ‚ Ù†ÙØ³Ù‡ğŸ˜Š</small>
</footer>

<script type="text/babel">
const { useState, useEffect } = React;

const KEYS = [
  '(', ')', 'âˆš', '^',
  '7', '8', '9', '/',
  '4', '5', '6', '*',
  '1', '2', '3', '-',
  '0', '.', '%', '+',
];

function sanitize(expr) {
  // Ù…Ø³Ù…ÙˆØ­ ÙÙ‚Ø· Ø¨Ø§Ù„Ø£Ø±Ù‚Ø§Ù… ÙˆØ§Ù„Ø¹ÙˆØ§Ù…Ø§Øª ÙˆØ§Ù„Ø±Ù…ÙˆØ² Ø§Ù„Ø­Ø³Ø§Ø¨ÙŠØ© Ø§Ù„Ù…Ø°ÙƒÙˆØ±Ø©
  if (!/^[0-9\\s+\\-*/().%^âˆš]*$/.test(expr)) return null;
  return expr
    .replace(/âˆš/g, 'Math.sqrt')
    .replace(/\^/g, '**');
}

function safeEval(expr) {
  const s = sanitize(expr);
  if (s == null) throw new Error('ØªØ¹Ø¨ÙŠØ± ØºÙŠØ± ØµØ§Ù„Ø­');
  // Ù…Ù†Ø¹ Ø£Ø´ÙŠØ§Ø¡ ØºØ±ÙŠØ¨Ø©: ØªØ£ÙƒØ¯ Ø£Ù†Ù‡ Ù…Ø§ Ø²Ø§Ù„ Ù…ÙƒÙˆÙ†Ø§Ù‹ Ù…Ù† Ø§Ù„Ø±Ù…ÙˆØ² Ø§Ù„Ù…Ø³Ù…ÙˆØ­Ø© Ø¨Ø¹Ø¯ Ø§Ù„Ø§Ø³ØªØ¨Ø¯Ø§Ù„
  if (!/^[0-9\\s+\\-*/().%*^Math.sqrt]*$/.test(s)) throw new Error('ØªØ¹Ø¨ÙŠØ± ØºÙŠØ± ØµØ§Ù„Ø­');
  // Ø§Ø³ØªØ®Ø¯Ù… Function Ù„ØªÙ‚ÙŠÙŠÙ… Ø¨Ø³ÙŠØ·
  // Ø¯Ø¹Ù… % ÙƒÙ†Ø³Ø¨Ø©: Ù†Ø­ÙˆÙ„ a % b Ø¥Ù„Ù‰ (a * b / 100) ÙÙ‚Ø· ÙÙŠ Ø­Ø§Ù„Ø© a op b% (Ø§Ø®ØªØµØ§Ø±)
  // Ù‡Ù†Ø§ Ù†ØªØ±Ùƒ % ÙƒÙ…Ø§ Ù‡Ùˆ ÙÙŠ JS (Ø¨Ø§Ù‚ÙŠ Ø§Ù„Ù‚Ø³Ù…Ø©)ØŒ Ù„ÙƒÙ† Ø²Ø± % Ø£Ø¯Ù†Ø§Ù‡ Ø³Ù†Ø¹Ø·ÙŠÙ‡ Ù…Ø¹Ù†Ù‰ Ø§Ù„Ù†Ø³Ø¨Ø© Ø¹Ù†Ø¯ Ø¥Ø¯Ø±Ø§Ø¬Ù‡
  return Function(`\"use strict\"; return (${s})`)();
}

const HISTORY_KEY = 'calc_history_v1';

function Calculator() {
  const [expr, setExpr] = useState('');
  const [result, setResult] = useState('0');
  const [history, setHistory] = useState([]);

  useEffect(() => {
    setHistory(Utils.load(HISTORY_KEY, []));
  }, []);

  function pushHistory(e, r) {
    const entry = { expr: e, result: String(r), ts: Date.now() };
    const next = [entry, ...history].slice(0, 100);
    setHistory(next);
    Utils.save(HISTORY_KEY, next);
  }

  function onKeyClick(k) {
    if (k === '%') {
      // Ø­ÙˆÙ‘Ù„ x + y% Ø¥Ù„Ù‰ x + (x*y/100) Ø¹Ù†Ø¯ Ø§Ù„Ø¥Ø¯Ø±Ø§Ø¬ Ø§Ù„Ø¨Ø³ÙŠØ·
      const m = expr.match(/(.*?)(\\d+\\.?\\d*)$/);
      if (m) {
        const base = m[1];
        const y = m[2];
        return setExpr(`${base}(${y}/100)`);
      }
    }
    setExpr(expr + k);
  }

  function clearAll() {
    setExpr(''); setResult('0');
  }

  function delOne() {
    setExpr(expr.slice(0, -1));
  }

  function compute() {
    try {
      const r = safeEval(expr);
      setResult(String(r));
      pushHistory(expr, r);
    } catch (e) {
      setResult('Ø®Ø·Ø£');
    }
  }

  function useHistory(item) {
    setExpr(item.expr);
    setResult(item.result);
  }

  return (
    <div className="calc">
      <div className="stack">
        <div className="display" aria-live="polite">{expr || '0'}</div>
        <div className="row">
          <button className="btn secondary" onClick={clearAll}>Ù…Ø³Ø­</button>
          <button className="btn secondary" onClick={delOne}>Ø­Ø°Ù</button>
          <button className="btn" onClick={compute} title="ÙŠØ³Ø§ÙˆÙŠ">=</button>
        </div>
        <div className="keys">
          {KEYS.map(k => (
            <button key={k} className={`key ${'+-*/^âˆš%'.includes(k) ? 'op':''} ${k==='='?'eq':''}`} onClick={() => onKeyClick(k)}>
              {k}
            </button>
          ))}
        </div>
      </div>
      <div className="pane">
        <div className="row" style={{justifyContent:'space-between', marginBottom:8}}>
          <h3 style={{margin:0}}>Ø§Ù„Ù†ØªÙŠØ¬Ø©: {result}</h3>
          <span className="badge">Ø§Ù„Ø³Ø¬Ù„</span>
        </div>
        <div className="history">
          {history.length === 0 ? <div>Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø³Ø¬Ù„ Ø¨Ø¹Ø¯</div> : history.map((h) => (
            <div className="history-item" key={h.ts}>
              <div>
                <div className="expr">{h.expr}</div>
                <div>= {h.result}</div>
              </div>
              <div className="history-actions">
                <button className="btn ghost" onClick={() => useHistory(h)}>Ø§Ø³ØªØ®Ø¯Ø§Ù…</button>
              </div>
            </div>
          ))}
        </div>
      </div>
    </div>
  );
}

ReactDOM.createRoot(document.getElementById('root')).render(<Calculator />);
</script>
</body>
</html>
