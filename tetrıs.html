<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8"/><meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>تتريس</title>
  <link rel="stylesheet" href="./shared.css"/>
  <script defer src="./shared.js"></script>
</head>
<body>
<header class="app-header">
  <div class="brand"><span class="logo">🧩</span><h1>تتريس</h1></div>
  <nav class="nav">
    <a href="./index.html">الرئيسية</a>
    <a href="./calculator.html">آلة حاسبة</a>
    <a href="./snake.html">الثعبان</a>
    <a href="./pacman.html">باكمان</a>
    <a href="./mario.html">سوبر ماريو</a>
  </nav>
  <button id="theme-toggle" class="btn">🌓</button>
</header>

<main class="container">
  <div class="canvas-wrap">
    <canvas id="tetris" width="300" height="600"></canvas>
    <div class="score pane">
      <div class="stack">
        <div class="controls">
          <div class="field">
            <label>السرعة</label>
            <select id="speed">
              <option value="800">سهل</option>
              <option value="500" selected>عادي</option>
              <option value="300">صعب</option>
            </select>
          </div>
          <button id="start" class="btn">بدء/إيقاف</button>
          <button id="reset" class="btn secondary">إعادة</button>
        </div>
        <div>النقاط: <strong id="points">0</strong></div>
        <div>الخطوط: <strong id="lines">0</strong></div>
        <div class="badge">لوحة المفاتيح: ← → ↓ للدفع، ↑ تدوير، Space إسقاط</div>
      </div>
      <div class="touchpad">
        <span></span><button data-act="rot">⤿</button><span></span>
        <button data-act="left">⬅️</button><button data-act="drop">⟂</button><button data-act="right">➡️</button>
        <span></span><button data-act="down">⬇️</button><span></span>
      </div>
    </div>
  </div>
</main>

<footer class="app-footer">
  <small>جميع الحقوق محفوظة 2025 — المطور ليث - مطور تطبيق رفيق نفسه😊</small>
</footer>

<script>
(function(){
  const canvas = document.getElementById('tetris');
  const ctx = canvas.getContext('2d');
  const COLS=10, ROWS=20, CELL=30;
  const COLORS = ['#000','#22c55e','#ef4444','#3b82f6','#f59e0b','#a855f7','#10b981','#eab308'];
  const SHAPES = {
    I: [[1,1,1,1]],
    O: [[1,1],[1,1]],
    T: [[0,1,0],[1,1,1]],
    S: [[0,1,1],[1,1,0]],
    Z: [[1,1,0],[0,1,1]],
    J: [[1,0,0],[1,1,1]],
    L: [[0,0,1],[1,1,1]],
  };
  const BAG = ['I','O','T','S','Z','J','L'];

  let grid, piece, nextBag=[], running=false, dropMs=500, last=0, acc=0, points=0, lines=0;

  function makeGrid(){ return Array.from({length:ROWS},()=>Array(COLS).fill(0)); }
  function newBag(){ const b=[...BAG]; for(let i=b.length-1;i>0;i--){ const j=Math.floor(Math.random()*(i+1)); [b[i],b[j]]=[b[j],b[i]];} return b; }
  function makePiece(type){
    const m = SHAPES[type].map(r=>r.slice());
    const color = 1 + Math.floor(Math.random()*7);
    return {m, x:Math.floor((COLS-m[0].length)/2), y:0, c:color};
  }
  function spawn(){
    if (nextBag.length===0) nextBag=newBag();
    const t = nextBag.pop();
    piece = makePiece(t);
    if (collide()) { gameOver(); }
  }
  function rotate(){
    const m=piece.m, h=m.length, w=m[0].length;
    const nm = Array.from({length:w},(_,x)=>Array.from({length:h},(_,y)=>m[h-1-y][x]));
    const old = piece.m; piece.m = nm;
    if (collide()) piece.m = old;
  }
  function collide(px=piece.x, py=piece.y, pm=piece.m){
    for (let y=0;y<pm.length;y++){
      for (let x=0;x<pm[y].length;x++){
        if (!pm[y][x]) continue;
        const gx = px + x, gy = py + y;
        if (gx<0 || gx>=COLS || gy>=ROWS) return true;
        if (gy>=0 && grid[gy][gx]) return true;
      }
    }
    return false;
  }
  function merge(){
    for (let y=0;y<piece.m.length;y++){
      for (let x=0;x<piece.m[y].length;x++){
        if (piece.m[y][x]){
          const gy = piece.y + y, gx = piece.x + x;
          if (gy>=0) grid[gy][gx] = piece.c;
        }
      }
    }
  }
  function clearLines(){
    let count=0;
    for (let y=ROWS-1;y>=0;){
      if (grid[y].every(v=>v!==0)){ grid.splice(y,1); grid.unshift(Array(COLS).fill(0)); count++; }
      else y--;
    }
    if (count>0){
      lines += count;
      const add = [0,100,300,500,800][count] || (count*200);
      points += add;
    }
  }
  function move(dx){
    if (!piece) return;
    if (!collide(piece.x + dx, piece.y, piece.m)) piece.x += dx;
  }
  function down(){
    if (!piece) return;
    if (!collide(piece.x, piece.y + 1, piece.m)) piece.y += 1;
    else { merge(); clearLines(); spawn(); }
  }
  function drop(){
    if (!piece) return;
    while(!collide(piece.x, piece.y+1, piece.m)) piece.y++;
    merge(); clearLines(); spawn();
  }
  function drawCell(x,y,c){
    ctx.fillStyle = COLORS[c]; ctx.fillRect(x*CELL, y*CELL, CELL-1, CELL-1);
  }
  function draw(){
    ctx.fillStyle='#0b0b0b'; ctx.fillRect(0,0,canvas.width,canvas.height);
    for (let y=0;y<ROWS;y++) for (let x=0;x<COLS;x++) if (grid[y][x]) drawCell(x,y,grid[y][x]);
    if (piece){
      for (let y=0;y<piece.m.length;y++)
        for (let x=0;x<piece.m[y].length;x++)
          if (piece.m[y][x]) drawCell(piece.x+x, piece.y+y, piece.c);
    }
    document.getElementById('points').textContent = points;
    document.getElementById('lines').textContent = lines;
  }
  function loop(ts){
    if (!running) return;
    const dt = ts - last; last = ts; acc += dt;
    if (acc >= dropMs) { down(); acc=0; }
    draw();
    requestAnimationFrame(loop);
  }
  function gameOver(){
    running=false;
    ctx.fillStyle='rgba(0,0,0,.6)'; ctx.fillRect(0,0,canvas.width,canvas.height);
    ctx.fillStyle='#fff'; ctx.font='24px sans-serif'; ctx.fillText('انتهت اللعبة! اضغط إعادة.', 40, canvas.height/2);
  }
  function reset(){
    grid = makeGrid(); piece=null; points=0; lines=0; spawn(); draw();
  }

  // controls
  document.getElementById('start').onclick=()=>{
    running = !running;
    if (running){ dropMs = Number(document.getElementById('speed').value); last=performance.now(); requestAnimationFrame(loop); }
  };
  document.getElementById('reset').onclick=()=>{ running=false; reset(); };

  window.addEventListener('keydown', (e)=>{
    if (!running && ['ArrowLeft','ArrowRight','ArrowDown','ArrowUp',' '].includes(e.key)) running=true, requestAnimationFrame(loop);
    if (e.key==='ArrowLeft') move(-1);
    if (e.key==='ArrowRight') move(1);
    if (e.key==='ArrowDown') down();
    if (e.key==='ArrowUp') rotate();
    if (e.key===' ') drop();
    draw();
  });
  document.querySelectorAll('.touchpad button').forEach(b=>{
    b.addEventListener('click', ()=>{
      const act = b.getAttribute('data-act');
      if (act==='left') move(-1);
      if (act==='right') move(1);
      if (act==='down') down();
      if (act==='rot') rotate();
      if (act==='drop') drop();
      draw();
    });
  });

  reset();
})();
</script>
</body>
</html>
